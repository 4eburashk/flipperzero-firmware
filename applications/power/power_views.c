#include "power_views.h"
#include "api-hal.h"

const uint8_t voltage_icon[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x03, 0x80, 0x01, 0xC0, 0x01, 0xE0, 0x00, 0xF0, 0x07,
    0x80, 0x03, 0xC0, 0x01, 0xC0, 0x00, 0x60, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t health_icon[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x01, 0x40, 0x01, 0x40, 0x01, 0x78, 0x0F, 0x08, 0x08,
    0x78, 0x0F, 0x40, 0x01, 0x40, 0x01, 0xC0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t temp_icon[] = {
    0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x40, 0x01, 0x40, 0x01, 0x40, 0x01, 0x40, 0x01, 0x40, 0x01,
    0x40, 0x01, 0x20, 0x02, 0xE0, 0x03, 0xE0, 0x03, 0xC0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t batt_icon[] = {
    0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0xC0, 0x03, 0x20, 0x04, 0x20, 0x04, 0xA0, 0x05, 0x20, 0x04,
    0xA0, 0x05, 0x20, 0x04, 0xA0, 0x05, 0x20, 0x04, 0xC0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t battery_normal[] = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x33, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xE9, 0xF9,
    0x7F, 0xF2, 0x3F, 0x2B, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00, 0x05, 0x00, 0x00, 0x00,
    0x00, 0x2B, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0xF5, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0xEB,
    0x0E, 0x01, 0x00, 0x00, 0x00, 0x00, 0x75, 0x0C, 0x05, 0x00, 0x00, 0x00, 0x00, 0xEB, 0x0E, 0x05,
    0x0F, 0x00, 0xE0, 0x01, 0xF5, 0x07, 0x85, 0x17, 0x00, 0xF0, 0x02, 0x2B, 0x00, 0x85, 0x1F, 0x00,
    0xF0, 0x03, 0x35, 0x00, 0x85, 0x1F, 0x00, 0xF0, 0x03, 0x2B, 0x00, 0x85, 0x1F, 0x00, 0xF0, 0x03,
    0x35, 0x00, 0x05, 0x0F, 0x00, 0xE0, 0x01, 0x2B, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x00, 0x2B, 0x00, 0x05, 0x00, 0x82, 0x00, 0x00, 0xF5, 0x07, 0x05, 0x00,
    0x82, 0x00, 0x00, 0xEB, 0x0F, 0x01, 0x00, 0x82, 0x00, 0x00, 0x75, 0x0C, 0x01, 0x00, 0x44, 0x00,
    0x00, 0xEB, 0x0F, 0x05, 0x00, 0x38, 0x00, 0x00, 0xF5, 0x07, 0x05, 0x00, 0x00, 0x00, 0x00, 0x2B,
    0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x2B, 0x00, 0xF1,
    0xE6, 0x7F, 0xFA, 0x28, 0x35, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x33, 0x00,
};

const uint8_t battery_charging[] = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x33, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xE9, 0xF9,
    0x7F, 0xF2, 0x3F, 0x2B, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00, 0x05, 0x00, 0x00, 0x00,
    0x00, 0x2B, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0xF5, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0xEB,
    0x0E, 0x01, 0x10, 0x00, 0x80, 0x00, 0x75, 0x0C, 0x05, 0x18, 0x00, 0xC0, 0x00, 0xEB, 0x0E, 0x05,
    0x0C, 0x00, 0x60, 0x00, 0xF5, 0x07, 0x05, 0x06, 0x00, 0x30, 0x00, 0x2B, 0x00, 0x05, 0x3F, 0x00,
    0xF8, 0x01, 0x35, 0x00, 0x05, 0x3F, 0x00, 0xF8, 0x01, 0x2B, 0x00, 0x05, 0x18, 0x00, 0xC0, 0x00,
    0x35, 0x00, 0x05, 0x0C, 0x00, 0x60, 0x00, 0x2B, 0x00, 0x05, 0x06, 0x00, 0x30, 0x00, 0x35, 0x00,
    0x05, 0x02, 0x00, 0x10, 0x00, 0x2B, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0xF5, 0x07, 0x05, 0x00,
    0x01, 0x01, 0x00, 0xEB, 0x0F, 0x01, 0x00, 0x82, 0x00, 0x00, 0x75, 0x0C, 0x01, 0x00, 0x7C, 0x00,
    0x00, 0xEB, 0x0F, 0x05, 0x00, 0x00, 0x00, 0x00, 0xF5, 0x07, 0x05, 0x00, 0x00, 0x00, 0x00, 0x2B,
    0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x2B, 0x00, 0xF1,
    0xE6, 0x7F, 0xFA, 0x28, 0x35, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x33, 0x00,
};

const uint8_t battery_over_consumption[] = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x33, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xE9, 0xF9,
    0x7F, 0xF2, 0x3F, 0x2B, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00, 0x05, 0x00, 0x00, 0x00,
    0x00, 0x2B, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0xF5, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0xEB,
    0x0E, 0x01, 0x20, 0x00, 0xE0, 0x03, 0x75, 0x0C, 0x05, 0x4E, 0x00, 0x10, 0x04, 0xEB, 0x0E, 0x05,
    0x51, 0x00, 0xC8, 0x01, 0xF5, 0x07, 0x85, 0x54, 0x00, 0x28, 0x02, 0x2B, 0x00, 0x85, 0x52, 0x00,
    0xA8, 0x02, 0x35, 0x00, 0x85, 0x4C, 0x24, 0x49, 0x02, 0x2B, 0x00, 0x05, 0x21, 0x92, 0x10, 0x01,
    0x35, 0x00, 0x05, 0x1E, 0x49, 0xE0, 0x00, 0x2B, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x00, 0x2B, 0x00, 0x05, 0x00, 0xFF, 0x03, 0x00, 0xF5, 0x07, 0x05, 0x80,
    0xFF, 0x07, 0x00, 0xEB, 0x0F, 0x01, 0x80, 0x03, 0x06, 0x00, 0x75, 0x0C, 0x01, 0x80, 0xFF, 0x07,
    0x00, 0xEB, 0x0F, 0x05, 0x00, 0x00, 0x00, 0x00, 0xF5, 0x07, 0x05, 0x00, 0x00, 0x00, 0x00, 0x2B,
    0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x2B, 0x00, 0xF1,
    0xE6, 0x7F, 0xFA, 0x28, 0x35, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x33, 0x00,
};

const uint8_t battery_low_power[] = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x33, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xE9, 0xF9,
    0x7F, 0xF2, 0x3F, 0x2B, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00, 0x05, 0x00, 0x00, 0x00,
    0x00, 0x2B, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0xF5, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0xEB,
    0x0E, 0x01, 0x00, 0x00, 0x00, 0x00, 0x75, 0x0C, 0x05, 0x30, 0x00, 0x18, 0x00, 0xEB, 0x0E, 0x05,
    0x30, 0x00, 0x18, 0x00, 0xF5, 0x07, 0x05, 0x38, 0x00, 0x38, 0x00, 0x2B, 0x00, 0x85, 0x1F, 0x00,
    0xF0, 0x03, 0x35, 0x00, 0x85, 0x0F, 0x00, 0xE0, 0x03, 0x2B, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00,
    0x35, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x2B, 0x00, 0x05, 0x00, 0xFE, 0x00, 0x00, 0x35, 0x00,
    0x05, 0x00, 0x83, 0x01, 0x00, 0x2B, 0x00, 0x05, 0x80, 0xFF, 0x03, 0x00, 0xF5, 0x07, 0x05, 0x80,
    0xFF, 0x03, 0x00, 0xEB, 0x0F, 0x01, 0x80, 0x83, 0x03, 0x00, 0x75, 0x0C, 0x01, 0x00, 0x00, 0x00,
    0x00, 0xEB, 0x0F, 0x05, 0x00, 0x00, 0x00, 0x00, 0xF5, 0x07, 0x05, 0x00, 0x00, 0x00, 0x00, 0x2B,
    0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x35, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x2B, 0x00, 0xF1,
    0xE6, 0x7F, 0xFA, 0x28, 0x35, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0x33, 0x00,
};

void draw_stat(Canvas* canvas, int x, int y, const uint8_t* icon, char* val) {
    int16_t text_pos = (16 - canvas_string_width(canvas, val)) / 2;
    canvas_draw_frame(canvas, x - 7, y + 7, 30, 13);
    canvas_draw_xbm(canvas, x, y, 16, 16, icon);
    canvas_set_color(canvas, ColorWhite);
    canvas_draw_box(canvas, x - 4, y + 16, 24, 6);
    canvas_set_color(canvas, ColorBlack);
    canvas_draw_str(canvas, x + text_pos, y + 22, val);
};

void draw_battery(Canvas* canvas, PowerInfoModel* data, int x, int y) {
    char header[20];
    char value[20];
    int8_t header_offset = 0;

    int32_t drain_current = -data->current_gauge * 1000;
    uint32_t charge_current = data->current_charger * 1000;

    // battery
    if(charge_current > 0) {
        canvas_draw_xbm(canvas, x, y, 52, 28, battery_charging);
    } else if(drain_current > 300) {
        canvas_draw_xbm(canvas, x, y, 52, 28, battery_over_consumption);
    } else if(data->charge < 10) {
        canvas_draw_xbm(canvas, x, y, 52, 28, battery_low_power);
    } else {
        canvas_draw_xbm(canvas, x, y, 52, 28, battery_normal);
    }

    // text
    if(charge_current > 0) {
        sprintf(header, "%s", "Charging:");
        sprintf(value, "%ld %s", charge_current, "mA");
    } else if(drain_current > 0) {
        sprintf(header, "%s", "Consumption:");
        snprintf(value, 32, "%ld %s", drain_current, "mA");
    } else if(charge_current != 0 || drain_current != 0) {
        header_offset = 6;
        sprintf(header, "%s", "...");
    } else {
        header_offset = 6;
        sprintf(header, "%s", "Charged!");
        memset(value, 0, strlen(value));
    }

    int16_t header_pos = (60 - canvas_string_width(canvas, header)) / 2;
    int16_t text_pos = (60 - canvas_string_width(canvas, value)) / 2;

    canvas_draw_str(canvas, 60 + header_pos, y + 10 + header_offset, header);
    canvas_draw_str(canvas, 60 + text_pos, y + 24, value);
};

void power_info_draw_callback(Canvas* canvas, void* context) {
    PowerInfoModel* data = context;

    canvas_clear(canvas);
    canvas_set_color(canvas, ColorBlack);

    draw_battery(canvas, data, 0, 5);

    char batt_level[20];
    char temperature[20];
    char voltage[20];
    char health[20];

    sprintf(batt_level, "%ld%s", (uint32_t)data->charge, "%");
    sprintf(temperature, " %ld %s", (uint32_t)data->temperature_charger, "C");
    sprintf(
        voltage,
        "%ld.%01ld V",
        (uint32_t)data->voltage_gauge,
        (uint32_t)(data->voltage_gauge * 10) % 10);
    sprintf(
        health,
        "%ld%s",
        100 - (((data->capacity_full - data->capacity_remaining) / data->capacity_full) * 100),
        "%");

    draw_stat(canvas, 8, 41, batt_icon, batt_level);
    draw_stat(canvas, 40, 41, temp_icon, temperature);
    draw_stat(canvas, 72, 41, voltage_icon, voltage);
    draw_stat(canvas, 104, 41, health_icon, health);
}
