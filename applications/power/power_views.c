#include "power_views.h"

const uint8_t voltage_icon[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x03, 0x80, 0x01, 0xC0, 0x01, 0xE0, 0x00, 0xF0, 0x07,
    0x80, 0x03, 0xC0, 0x01, 0xC0, 0x00, 0x60, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t health_icon[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x01, 0x40, 0x01, 0x40, 0x01, 0x78, 0x0F, 0x08, 0x08,
    0x78, 0x0F, 0x40, 0x01, 0x40, 0x01, 0xC0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t temp_icon[] = {
    0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x40, 0x01, 0x40, 0x01, 0x40, 0x01, 0x40, 0x01, 0x40, 0x01,
    0x40, 0x01, 0x20, 0x02, 0xE0, 0x03, 0xE0, 0x03, 0xC0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t batt_icon[] = {
    0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0xC0, 0x03, 0x20, 0x04, 0x20, 0x04, 0xA0, 0x05, 0x20, 0x04,
    0xA0, 0x05, 0x20, 0x04, 0xA0, 0x05, 0x20, 0x04, 0xC0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t battery_body[] = {
    0xC0, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F, 0xC0, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x08, 0x40, 0xCD,
    0xFF, 0xE4, 0xFF, 0x79, 0x09, 0xC0, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x08, 0x40, 0x0D, 0x00, 0x00,
    0x00, 0x00, 0x0A, 0xFE, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x77, 0x0D, 0x00, 0x00, 0x00, 0x00,
    0x08, 0xE3, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x08, 0x77, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xFE,
    0x0A, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x40, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xC0, 0x0A, 0x00,
    0x00, 0x00, 0x00, 0x0A, 0x40, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xC0, 0x0A, 0x00, 0x00, 0x00,
    0x00, 0x0A, 0x40, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xC0, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x0A,
    0x40, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xFE, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x7F, 0x0D,
    0x00, 0x00, 0x00, 0x00, 0x0A, 0xE3, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x08, 0x7F, 0x0D, 0x00, 0x00,
    0x00, 0x00, 0x08, 0xFE, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x40, 0x0D, 0x00, 0x00, 0x00, 0x00,
    0x0A, 0xC0, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x40, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x0A, 0xC0,
    0x4A, 0xF1, 0xE5, 0x7F, 0xF6, 0x08, 0xC0, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x08, 0xC0, 0xFC, 0xFF,
    0xFF, 0xFF, 0xFF, 0x0F,
};

const uint8_t face_normal[] = {
    0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x80, 0x07, 0x5E, 0x00, 0xC0, 0x0B, 0x7E, 0x00,
    0xC0, 0x0F, 0x7E, 0x00, 0xC0, 0x0F, 0x7E, 0x00, 0xC0, 0x0F, 0x3C, 0x00, 0x80, 0x07,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x02, 0x00, 0x00, 0x08,
    0x02, 0x00, 0x00, 0x08, 0x02, 0x00, 0x00, 0x10, 0x01, 0x00, 0x00, 0xE0, 0x00, 0x00,
};

const uint8_t face_charging[] = {
    0x40, 0x00, 0x00, 0x02, 0x60, 0x00, 0x00, 0x03, 0x30, 0x00, 0x80, 0x01, 0x18, 0x00,
    0xC0, 0x00, 0xFC, 0x00, 0xE0, 0x07, 0xFC, 0x00, 0xE0, 0x07, 0x60, 0x00, 0x00, 0x03,
    0x30, 0x00, 0x80, 0x01, 0x18, 0x00, 0xC0, 0x00, 0x08, 0x00, 0x40, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x04, 0x04, 0x00, 0x00, 0x08, 0x02, 0x00, 0x00, 0xF0, 0x01, 0x00,
};

const uint8_t face_over_consumption[] = {
    0x80, 0x00, 0x80, 0x0F, 0x38, 0x01, 0x40, 0x10, 0x44, 0x01, 0x20, 0x07, 0x52, 0x01,
    0xA0, 0x08, 0x4A, 0x01, 0xA0, 0x0A, 0x32, 0x91, 0x24, 0x09, 0x84, 0x48, 0x42, 0x04,
    0x78, 0x24, 0x81, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC,
    0x0F, 0x00, 0x00, 0xFE, 0x1F, 0x00, 0x00, 0x0E, 0x18, 0x00, 0x00, 0xFE, 0x1F, 0x00,
};

const uint8_t face_low_power[] = {
    0x00, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x60, 0x00, 0xC0, 0x00, 0x60, 0x00, 0xE0, 0x00,
    0xE0, 0x00, 0x7E, 0x00, 0xC0, 0x0F, 0x3E, 0x00, 0x80, 0x0F, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x03, 0x00, 0x00, 0x0C, 0x06, 0x00, 0x00, 0xFE,
    0x0F, 0x00, 0x00, 0xFE, 0x0F, 0x00, 0x00, 0x0E, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00,
};

void draw_stat(Canvas* canvas, int x, int y, const uint8_t* icon, char* val) {
    int16_t text_pos = (16 - canvas_string_width(canvas, val)) / 2;
    canvas_draw_frame(canvas, x - 7, y + 7, 30, 13);
    canvas_draw_xbm(canvas, x, y, 16, 16, icon);
    canvas_set_color(canvas, ColorWhite);
    canvas_draw_box(canvas, x - 4, y + 16, 24, 6);
    canvas_set_color(canvas, ColorBlack);
    canvas_draw_str(canvas, x + text_pos, y + 22, val);
};

void draw_battery(Canvas* canvas, PowerInfoModel* data, int x, int y) {
    char emote[20];
    char header[20];
    char value[20];

    int8_t header_offset = 0;
    int32_t drain_current = -data->current_gauge * 1000;
    uint32_t charge_current = data->current_charger * 1000;
    uint32_t charger_voltage = data->voltage_charger;

    // battery
    canvas_draw_xbm(canvas, x, y, 52, 28, battery_body);
    if(charge_current > 0) {
        canvas_draw_xbm(canvas, x + 16, y + 7, 29, 14, face_charging);
    } else if(drain_current > 100) {
        canvas_draw_xbm(canvas, x + 16, y + 7, 29, 14, face_over_consumption);
    } else if(data->charge < 10) {
        canvas_draw_xbm(canvas, x + 16, y + 7, 29, 14, face_low_power);
    } else {
        canvas_draw_xbm(canvas, x + 16, y + 7, 29, 14, face_normal);
    }

    //bubble
    canvas_draw_frame(canvas, 57, 0, 71, 39);
    canvas_draw_line(canvas, 53, 23, 57, 19);
    canvas_draw_line(canvas, 53, 23, 57, 27);
    canvas_set_color(canvas, ColorWhite);
    canvas_draw_box(canvas, 57, 0, 2, 2);
    canvas_draw_box(canvas, 57, 37, 2, 2);
    canvas_draw_box(canvas, 126, 0, 2, 2);
    canvas_draw_box(canvas, 126, 37, 2, 2);
    canvas_draw_line(canvas, 57, 20, 57, 26);
    canvas_set_color(canvas, ColorBlack);
    canvas_draw_dot(canvas, 58, 1);
    canvas_draw_dot(canvas, 58, 37);
    canvas_draw_dot(canvas, 126, 1);
    canvas_draw_dot(canvas, 126, 37);

    // text
    if(charge_current > 0) {
        sprintf(emote, "%s", "Yummy!");
        sprintf(header, "%s", "Charging at");
        sprintf(
            value,
            "%ld.%01ld%s   %ld%s",
            charger_voltage,
            (charger_voltage * 10) % 10,
            "V",
            charge_current,
            "mA");
    } else if(drain_current > 0) {
        sprintf(emote, "%s", drain_current > 100 ? "Oh no!" : "Om-nom-nom!");
        sprintf(header, "%s", "Consumption is");
        snprintf(value, 32, "%ld %s", drain_current, drain_current > 100 ? "mA!" : "mA");
    } else if(charge_current != 0 || drain_current != 0) {
        header_offset = -2;
        sprintf(header, "%s", "...");
        memset(value, 0, strlen(value));
        memset(emote, 0, strlen(emote));
    } else {
        header_offset = -2;
        sprintf(header, "%s", "Charged!");
        memset(value, 0, strlen(value));
        memset(emote, 0, strlen(emote));
    }

    int16_t emote_pos = (60 - canvas_string_width(canvas, emote)) / 2;
    int16_t header_pos = (60 - canvas_string_width(canvas, header)) / 2;
    int16_t text_pos = (60 - canvas_string_width(canvas, value)) / 2;

    canvas_draw_str(canvas, 62 + emote_pos, y + 6, emote);
    canvas_draw_str(canvas, 62 + header_pos, y + 18 + header_offset, header);
    canvas_draw_str(canvas, 62 + text_pos, y + 30, value);
};

void power_info_draw_callback(Canvas* canvas, void* context) {
    PowerInfoModel* data = context;

    canvas_clear(canvas);
    canvas_set_color(canvas, ColorBlack);
    draw_battery(canvas, data, 0, 5);

    char batt_level[10];
    char temperature[10];
    char voltage[10];
    char health[10];

    sprintf(batt_level, "%ld%s", (uint32_t)data->charge, "%");
    sprintf(temperature, "%ld %s", (uint32_t)data->temperature_gauge, "C");
    sprintf(
        voltage,
        "%ld.%01ld V",
        (uint32_t)data->voltage_gauge,
        (uint32_t)(data->voltage_gauge * 10) % 10);
    sprintf(
        health,
        "%ld%s",
        100 - (((data->capacity_full - data->capacity_remaining) / data->capacity_full) * 100),
        "%");

    draw_stat(canvas, 8, 42, batt_icon, batt_level);
    draw_stat(canvas, 40, 42, temp_icon, temperature);
    draw_stat(canvas, 72, 42, voltage_icon, voltage);
    draw_stat(canvas, 104, 42, health_icon, health);
}
